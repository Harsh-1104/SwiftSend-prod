<!DOCTYPE html>
<html
  lang="en"
  data-layout="vertical"
  data-topbar="light"
  data-sidebar="dark"
  data-sidebar-size="lg"
  data-sidebar-image="none"
  data-preloader="disable"
>
  <head>
    <meta charset="utf-8" />
    <title>Dashboard | SwiftSends</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      content="Premium Multipurpose Admin & Dashboard Template"
      name="description"
    />
    <meta content="Themesbrand" name="author" />
    <!-- App favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" />

    <!-- jsvectormap css -->
    <link
      href="/assets/libs/jsvectormap/css/jsvectormap.min.css"
      rel="stylesheet"
      type="text/css"
    />

    <!--Swiper slider css-->
    <link
      href="/assets/libs/swiper/swiper-bundle.min.css"
      rel="stylesheet"
      type="text/css"
    />

    <!-- Layout config Js -->
    <script src="/assets/js/layout.js"></script>
    <!-- Bootstrap Css -->
    <link
      href="/assets/css/bootstrap.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <!-- Icons Css -->
    <link href="/assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="/assets/css/app.min.css" rel="stylesheet" type="text/css" />
    <!-- custom Css-->
    <link href="/assets/css/custom.min.css" rel="stylesheet" type="text/css" />

    <!-- Font Awesome Files -->
    <link href="/assets/fontawesome/css/all.min.css" rel="stylesheet" />
    <link href="/assets/fontawesome/css/solid.css" rel="stylesheet" />
    <link href="/assets/fontawesome/css/solid.min.css" rel="stylesheet" />
    <link href="/assets/fontawesome/css/regular.css" rel="stylesheet" />
    <link href="/assets/fontawesome/css/regular.min.css" rel="stylesheet" />
    <link href="/assets/fontawesome/css/fontawesome.min.css" rel="stylesheet" />
    <link href="/assets/fontawesome/css/fontawesome.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7096395024403516"
        crossorigin="anonymous"></script> -->
  </head>
  <style>
    .refresh {
      transition: all 0.1s linear;
    }

    .refresh.down {
      transform: rotate(180deg);
    }

    textarea {
      resize: none;
    }
  </style>

  <body>
    <!-- Begin page -->
    <div id="layout-wrapper">
      <header id="page-topbar">
        <div class="layout-width">
          <div class="navbar-header">
            <div class="d-flex">
              <!-- LOGO -->
              <div class="navbar-brand-box horizontal-logo">
                <a href="/" class="logo logo-dark">
                  <span class="logo-sm">
                    <img src="/assets/images/logo-sm.svg" alt="" height="60" />
                  </span>
                  <span class="logo-lg">
                    <img
                      src="/assets/images/logo-dark.svg"
                      alt=""
                      height="100"
                      width="200"
                    />
                  </span>
                </a>

                <a href="/" class="logo logo-light">
                  <span class="logo-sm">
                    <img src="/assets/images/logo-sm.svg" alt="" height="60" />
                  </span>
                  <span class="logo-lg">
                    <img
                      src="/assets/images/logo-dark.svg"
                      alt=""
                      height="100"
                      width="200"
                    />
                  </span>
                </a>
              </div>

              <button
                type="button"
                class="btn btn-sm px-3 fs-16 header-item vertical-menu-btn topnav-hamburger"
                id="topnav-hamburger-icon"
              >
                <span class="hamburger-icon">
                  <span></span>
                  <span></span>
                  <span></span>
                </span>
              </button>
            </div>

            <div class="d-flex align-items-center">
              <div class="ms-1 header-item">
                <button
                  type="button"
                  class="btn btn-icon btn-topbar btn-ghost-secondary rounded-circle"
                  data-toggle="fullscreen"
                >
                  <i class="bx bx-fullscreen fs-22"></i>
                </button>
              </div>

              <div class="ms-1 header-item">
                <button
                  type="button"
                  class="btn btn-icon btn-topbar btn-ghost-secondary rounded-circle light-dark-mode"
                >
                  <i class="bx bx-moon fs-22"></i>
                </button>
              </div>

              <div class="dropdown ms-sm-3 header-item topbar-user">
                <button
                  type="button"
                  class="btn"
                  id="page-header-user-dropdown"
                  data-bs-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <span class="d-flex align-items-center">
                    <img
                      class="rounded-circle header-profile-user profileimg"
                    />
                    <span class="text-start ms-xl-2">
                      <span
                        class="d-none d-xl-inline-block ms-1 fw-medium user-name-text profilename"
                      ></span>
                      <span
                        class="d-none d-xl-block ms-1 fs-12 text-muted user-name-sub-text"
                      >
                        Founder
                      </span>
                    </span>
                  </span>
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                  <!-- item-->
                  <h6 class="dropdown-header">
                    Welcome <span class="profilename"></span>
                  </h6>
                  <a class="dropdown-item" href="/profile">
                    <i
                      class="mdi mdi-account-circle text-muted fs-16 align-middle me-1"
                    ></i>
                    <span class="align-middle">Profile</span>
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" id="logout">
                    <i
                      class="mdi mdi-logout text-muted fs-16 align-middle me-1"
                    ></i>
                    <span class="align-middle" data-key="t-logout">Logout</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- ========== App Menu ========== -->
      <div class="app-menu navbar-menu">
        <!-- LOGO -->
        <div class="navbar-brand-box">
          <!-- Dark Logo-->
          <a href="/" class="logo logo-dark">
            <span class="logo-sm">
              <img src="/assets/images/logo-sm.svg" alt="" height="60" />
            </span>
            <span class="logo-lg">
              <img
                src="/assets/images/logo-dark.svg"
                alt=""
                height="100"
                width="200"
              />
            </span>
          </a>
          <!-- Light Logo-->
          <a href="/" class="logo logo-light">
            <span class="logo-sm">
              <img src="/assets/images/logo-sm.svg" alt="" height="60" />
            </span>
            <span class="logo-lg">
              <img
                src="/assets/images/logo-dark.svg"
                alt=""
                height="100"
                width="200"
              />
            </span>
          </a>
          <button
            type="button"
            class="btn btn-sm p-0 fs-20 header-item float-end btn-vertical-sm-hover"
            id="vertical-hover"
          >
            <i class="ri-record-circle-line"></i>
          </button>
        </div>

        <div id="scrollbar">
          <div class="container-fluid">
            <div id="two-column-menu"></div>
            <ul class="navbar-nav" id="navbar-nav"></ul>
          </div>
        </div>

        <div class="sidebar-background"></div>
      </div>
      <!-- Left Sidebar End -->
      <!-- Vertical Overlay-->
      <!--  <div class="vertical-overlay"></div>-->

      <!-- ============================================================== -->
      <!-- Start right Content here -->
      <!-- ============================================================== -->
      <div class="main-content">
        <div class="page-content">
          <div class="container-fluid">
            <div
              class="page-title-box d-sm-flex align-items-center justify-content-between"
            >
              <div class="page-title">
                <ol class="breadcrumb m-0" id="api_path">
                  <li class="breadcrumb-item">
                    <a href="/instance"> Instance </a>
                  </li>
                  <li class="breadcrumb-item" id="i_name"></li>
                  <li class="breadcrumb-item active">Business API</li>
                </ol>
              </div>
            </div>
            <div class="card" id="msgform">
              <h3 class="card-header text-center">Whatsapp Business API</h3>
              <div class="card-body">
                <div class="mb-3">
                  <label for="image" class="form-label">
                    Phone no
                    <span class="text-danger">*</span>
                    <span class="text-danger" id="err_phone"></span>
                  </label>
                  <input
                    type="text"
                    class="form-control required mb-2"
                    id="phone"
                    placeholder="xxxxx xxxxx"
                    data-type="phone"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label" id="template_lbl">Templates</label>
                  <select id="template" class="form-select"></select>
                </div>
                <div id="Headerdynamic"></div>
                <div id="Bodydynamic"></div>
                <div class="mb-3 d-none" id="imageform">
                  <label for="document_file" class="form-label">
                    Document
                    <span class="text-danger">*</span>
                    <span class="text-danger" id="err_document_file"></span>
                  </label>
                  <input
                    type="file"
                    id="document_file"
                    class="form-control required"
                    data-type="message"
                    multiple
                  />
                </div>
                <div class="mb-3">
                  <div class="btn-group dropup">
                    <button id="sendmsg" class="btn btn-primary btn-load">
                      <i class="mdi mdi-send me-lg-2 me-md-2"></i>
                      <span class="d-none d-lg-inline-block d-md-inline-block">
                        Send
                      </span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <script>
              var cdate = new Date();
              let date_str = `${
                cdate.getMonth() + 1
              }/${cdate.getDate()}/${cdate.getFullYear()}`;
              let time_str = `${cdate.getHours() + 1}:${cdate.getMinutes()}`;

              document
                .getElementById("message_date")
                .setAttribute("data-minDate", date_str);
              document
                .getElementById("message_date")
                .setAttribute("data-deafult-date", date_str);
              document
                .getElementById("message_time")
                .setAttribute("data-time-inline", time_str);

              document
                .getElementById("document_date")
                .setAttribute("data-minDate", date_str);
              document
                .getElementById("document_date")
                .setAttribute("data-deafult-date", date_str);
              document
                .getElementById("document_time")
                .setAttribute("data-time-inline", time_str);
            </script>

            <footer class="footer"></footer>
          </div>
        </div>
        <!-- END layout-wrapper -->

        <!--start back-to-top-->
        <button
          onclick="topFunction()"
          class="btn btn-danger btn-icon"
          id="back-to-top"
        >
          <i class="ri-arrow-up-line"></i>
        </button>
        <!--end back-to-top-->

        <!--preloader-->
        <div id="preloader">
          <div id="status">
            <div class="spinner-border text-primary avatar-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>

        <div class="customizer-setting" id="chatbot">
          <div class="btn-info btn-rounded shadow-lg btn btn-icon btn-lg p-2">
            <i class="fa-solid fa-comment" id="iconchat"></i>
          </div>
        </div>

        <div
          class="email-chat-detail"
          id="emailchat-detailElem"
          style="display: none"
        >
          <div class="card mb-0">
            <div
              class="card-header align-items-center d-flex bg-primary text-white-50"
            >
              <div class="flex-grow-1">
                <h5 class="fs-15 text-white mb-1 profile-username">
                  SwiftSend ChatBot
                </h5>
                <p class="mb-0 fs-12 lh-1">Ask here for help</p>
              </div>
              <div>
                <i class="fa-brands fa-bots fs-1 text-white"></i>
              </div>
            </div>

            <div class="card-body p-0">
              <div id="users-chat">
                <div
                  class="chat-conversation p-3"
                  id="chat-conversation"
                  data-simplebar
                  style="height: 250px"
                >
                  <ul
                    class="list-unstyled chat-conversation-list chat-sm"
                    id="conversation"
                  ></ul>
                </div>
              </div>

              <div class="border-top border-top-dashed">
                <div class="row g-2 mx-3 mt-2 mb-3">
                  <div class="col">
                    <div class="position-relative">
                      <input
                        type="text"
                        class="form-control border-light bg-light message-input"
                        placeholder="Enter Message..."
                        id="input"
                      />
                    </div>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-info" id="sendbotmsg">
                      <i class="mdi mdi-send"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- JAVASCRIPT -->
    <script src="/assets/js/jquery.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/validate.js"></script>
    <script src="/assets/js/chatbot.js"></script>
    <script src="/assets/js/voiceRecognition.js"></script>

    <script src="/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/libs/simplebar/simplebar.min.js"></script>
    <script src="/assets/libs/node-waves/waves.min.js"></script>
    <script src="/assets/libs/feather-icons/feather.min.js"></script>
    <script src="/assets/js/pages/plugins/lord-icon-2.1.0.js"></script>
    <script src="/assets/js/plugins.js"></script>

    <!-- cleave.js -->
    <script src="/assets/libs/cleave.js/cleave.min.js"></script>
    <!-- form masks init -->
    <script src="/assets/js/pages/form-masks.init.js"></script>

    <!-- aos js -->
    <script src="/assets/libs/aos/aos.js"></script>
    <!-- prismjs plugin -->
    <script src="/assets/libs/prismjs/prism.js"></script>
    <!-- animation init -->
    <script src="/assets/js/pages/animation-aos.init.js"></script>

    <!-- App js -->
    <script src="/assets/js/app.js"></script>

    <!-- prismjs plugin -->
    <script src="/assets/libs/prismjs/prism.js"></script>

    <script src="/assets/sweetalert2/sweet-alert.init.js"></script>
    <script src="/assets/sweetalert2/sweetalert2.all.js"></script>

    <script>
      $(document).ready(() => {
        chkLogin();
        let template_list = [];
        const iid = document.URL.split("/")[4];

        var output = "";
        function display_template() {
          $.ajax({
            url: "/api/template/gettemplate",
            method: "GET",
            success: function (val) {
              var output = "",
                data = "";
              output += `<option value="" selected disabled>Select template</option>`;
              if (val.data.length <= 0) {
                // output += `
                //     <option>
                //         <div class="noresult p-5 container d-flex align-items-center justify-content-center">
                //             <div class="text-center">
                //                 <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop"
                //                     colors="primary:#212529,secondary:#405189"
                //                     style="width: 75px; height: 75px"></lord-icon>
                //                 <h5 class="mt-2">No Template created</h5>
                //             </div>
                //         </div>
                //     </option>`;
              } else {
                template_list = val.data;
                for (let i in val.data) {
                  output += `<option value="${val.data[i].id}">${val.data[i].name}</option>`;
                }
                console.log(template_list);
              }
              $("#template").html(output);
            },
            error: (error) => {
              if (error.status === 500) InternalServerError();
              if (error.status === 401) InvalidUser();
            },
          });
        }
        display_template();

        function countPlaceholders(message) {
          // Regular expression to match placeholders like {{1}}, {{2}}, etc.

          if (message != null) {
            const placeholderRegex = /\{\{\d+\}\}/g;

            // Match all placeholders in the message
            const matches = message.match(placeholderRegex);

            // Count the number of matches
            const count = matches ? matches.length : 0;

            return count;
          }
          return 0;
        }

        $("#template").on("change", () => {
          var msg = "";
          var bodymsg = "";
          $("#Headerdynamic").html();

          var x = template_list.filter((x) => x.id === $("#template").val());

          console.log("X : ", x);

          if (x[0].components) {
            x[0].components.forEach((component) => {
              if (component.type === "HEADER") {
                const headerFormat = component.format;
                const headerText = component.text;
                var userfields = countPlaceholders(headerText || null);

                switch (component.format) {
                  case "TEXT":
                    $("#Headerdynamic").html("");
                    for (let i = 1; i <= userfields; i++) {
                      msg = `<div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                                  <label for="Header${i}" class="form-label">
                                      HEADER Dynamic Value
                                      <span class="text-danger">*</span>
                                      <span class="text-danger" id="err_col${i}"></span>
                                  </label>
                                     <input type="text" id="header${i}" class="form-control" placeholder="Enter dynamic data"
                                     ></div>`;
                    }
                    break;
                  case "IMAGE":
                    msg = `<div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                        <label for="IMAGE" class="form-label">
                                      IMAGE
                                      <span class="text-danger">*</span>
                                      <span class="text-danger" id="ere_col"></span>
                                  </label>
                                     <input type="file" id="IMAGE" class="form-control">
                                     </div>`;
                    break;
                  case "DOCUMENT":
                    msg = `<div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                                  <label for="DOCUMENT" class="form-label">
                                      DOCUMENT
                                      <span class="text-danger">*</span>
                                      <span class="text-danger" id="err_col"></span>
                                  </label>
                                     <input type="file" id="DOCUMENT" class="form-control"
                                     ></div>`;
                    break;
                  default:
                    msg = "";
                    break;
                }
                $("#Headerdynamic").html(msg);
              }
              if (component.type === "BODY") {
                const bodyText = component.text;
                var bodyuserfields = countPlaceholders(bodyText || null);
                console.log("bu", bodyuserfields);
                for (let i = 1; i <= bodyuserfields; i++) {
                  bodymsg += `<div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                                  <label for="BODY${i}" class="form-label">
                                    {{${i}}}
                                      <span class="text-danger">*</span>
                                      <span class="text-danger" id="err_col${i}"></span>
                                  </label>
                                     <input type="text" id="header${i}" class="form-control" placeholder="Enter dynamic data"
                                     ></div>`;
                }
                $("#Bodydynamic").html(bodymsg);
              }
            });
          }
        });

        $(document).on("click", "#sendmsg", function () {
          nullfield_validation("phone");
          nullfield_validation("template");

          if (objFlag.flag_phone == 0 && objFlag.flag_template == 0) {
            let formData = new FormData();
            formData.append("iid", iid);
            formData.append("phone", $("#phone").val().trim());
            formData.append("template", $("#template").val().split("/")[0]);
            formData.append("lang", $("#template").val().split("/")[1]);
            if (
              $("#template").val().split("/")[0] == "qc_report" ||
              $("#template").val().split("/")[0] == "report_doc"
            ) {
              const file_data =
                document.getElementById("document_file").files[0];
              formData.append("image", file_data);
            }
            $.ajax({
              url: "/wba/sendTemplate",
              method: "POST",
              data: formData,
              contentType: false,
              processData: false,
              beforeSend: function () {
                $("#sendmsg")
                  .removeClass("btn-primary btn-success")
                  .addClass("btn-warning")
                  .html(`<span class= "d-flex align-items-center">
                                                    <span class="flex-grow-1 me-2">
                                                        Sending
                                                    </span>
                                                    <span class="spinner-border flex-shrink-0" role="status">
                                                        <span class="visually-hidden"></span>
                                                    </span>
                                                </span>`);
              },
              success: (result) => {
                console.log(result);
                if (result.Status == 200) {
                  swal({
                    title: `Message sent.`,
                    type: "success",
                    timer: 2000,
                    showConfirmButton: false,
                  }).then(function () {
                    $("#phone").val("");
                    $("#sendmsg")
                      .removeClass("btn-success btn-warning")
                      .addClass(
                        "btn-primary"
                      ).html(`<i class= "mdi mdi-send me-lg-2 me-md-2"></i>
                                                            <span class="d-none d-lg-inline-block d-md-inline-block">
                                                                Send
                                                            </span>`);
                  });
                } else {
                  swal({
                    title: `Error in sending Message`,
                    type: "error",
                    timer: 2000,
                    showConfirmButton: false,
                  }).then(function () {
                    $("#sendmsg")
                      .removeClass("btn-success btn-warning")
                      .addClass(
                        "btn-primary"
                      ).html(`<i class= "mdi mdi-send me-lg-2 me-md-2"></i>
                                                            <span class="d-none d-lg-inline-block d-md-inline-block">
                                                                Send
                                                            </span>`);
                  });
                }
              },
              error: (error) => {
                console.log(error);
              },
            });
          }
        });
      });
    </script>
  </body>
</html>
